# Plan: Cortex -- Persistent Memory Plugin

**Spec:** `.claude/specs/2026-02-06-cortex/spec.md`
**Created:** 2026-02-06

## Summary

Cortex is a native Claude Code plugin that gives Claude persistent, project-aware memory with semantic search and code indexing. Built as pure TypeScript compiled for bun, using SQLite (better-sqlite3) for storage, Voyage AI for embeddings, and Haiku API for extraction/consolidation. Architecture follows functional core / imperative shell: pure ranking, decay, and graph functions with I/O pushed to edges (DB, API calls, filesystem).

---

## Architectural Decisions

### AD-1: TypeScript Engine with Bun Runtime

**Choice:** Pure TypeScript compiled to JS, invoked via `bun ${CLAUDE_PLUGIN_ROOT}/engine/dist/cli.js`
**Why:** Matches existing `.claude/hooks/ts-utils/` patterns. No pip install needed. better-sqlite3 works as native addon in bun. Hooks already call bun for TS parsing.
**Rejected:**
- Python engine -- requires separate pip install, no bundling in plugin dir, additional runtime dependency
- Node.js (without bun) -- bun already required by existing hooks, bun is faster for CLI invocation

### AD-2: Dual-DB Architecture (Project + Global)

**Choice:** `.memory/cortex.db` per project, `~/.claude/memory/cortex-global.db` for cross-project
**Why:** Project isolation by default. Global DB enables "how do I usually do X" across projects. LLM classifies at extraction time (FR-003a).
**Rejected:**
- Single DB with project column -- cross-project queries slow, no natural isolation
- File-per-memory -- no relational queries, no FTS5, no graph edges

### AD-3: Voyage AI Primary, Local Embedding Fallback

**Choice:** Voyage AI (voyage-3.5-lite, 1024d) primary with @huggingface/transformers all-MiniLM-L6-v2 (384d) fallback
**Why:** Voyage is Anthropic's official partner, 200M tokens/month free tier. Local fallback enables offline mode (FR-005, NFR-010).
**Rejected:**
- Local-only -- significantly worse semantic quality for recall
- Voyage-only -- no offline capability, hard requirement per NFR-043

### AD-4: Functional Core for Ranking, Decay, and Graph

**Choice:** All ranking, decay, centrality, and surface generation as pure functions. DB/API calls at edges only.
**Why:** 90%+ unit testable without mocks. Property tests for decay math, ranking invariants. Matches architecture rules (FP, push I/O to edges).
**Rejected:**
- OOP service layer -- harder to test, mocks everywhere
- Mixed I/O+logic -- existing anti-pattern to avoid

### AD-5: Push Surface as `.claude/cortex-memory.local.md`

**Choice:** Generate `.claude/cortex-memory.local.md` with markers `<!-- CORTEX:START -->` / `<!-- CORTEX:END -->`
**Why:** Auto-loaded by Claude Code (`.local.md` convention). Auto-gitignored. Preserves hand-written content outside markers.
**Rejected:**
- Append to project CLAUDE.md -- risk of merge conflicts, pollutes tracked file
- Separate `.claude/memory.md` -- not auto-loaded without explicit config

### AD-6: CLI Command Dispatch Pattern

**Choice:** Single CLI entrypoint `cli.ts` with subcommands: `extract`, `recall`, `remember`, `index`, `forget`, `consolidate`, `generate`, `lifecycle`
**Why:** Each hook/skill invokes one subcommand. Clean separation. Each subcommand is thin I/O shell orchestrating pure core functions.
**Rejected:**
- Separate script files per command -- duplication of DB init, config loading
- Library-only (no CLI) -- hooks need CLI invocation pattern per existing conventions

### AD-7: Discriminated Union for Memory Types

**Choice:** TypeScript discriminated union `MemoryType` with exhaustive matching via ts-pattern
**Why:** Compiler-enforced exhaustiveness for decay half-lives, ranking weights, push surface budgets. Prevents missing-case bugs.
**Rejected:**
- String enums -- no exhaustive checking
- Plain strings -- no type safety at all

---

## File Structure

### Engine Core (Domain)

```
.claude/plugins/cortex/engine/src/domain/types.ts           -- Memory, Edge, Extraction types (discriminated unions)
.claude/plugins/cortex/engine/src/domain/ranking.ts          -- pure ranking formula, push surface scoring
.claude/plugins/cortex/engine/src/domain/ranking.test.ts     -- unit + property tests for ranking
.claude/plugins/cortex/engine/src/domain/decay.ts            -- confidence decay calculation (pure)
.claude/plugins/cortex/engine/src/domain/decay.test.ts       -- property tests: decay invariants
.claude/plugins/cortex/engine/src/domain/graph.ts            -- centrality computation, edge classification (pure)
.claude/plugins/cortex/engine/src/domain/graph.test.ts       -- unit tests for centrality, edge creation
.claude/plugins/cortex/engine/src/domain/similarity.ts       -- cosine similarity (pure math)
.claude/plugins/cortex/engine/src/domain/similarity.test.ts  -- property tests: similarity invariants
.claude/plugins/cortex/engine/src/domain/surface.ts          -- push surface markdown generation (pure)
.claude/plugins/cortex/engine/src/domain/surface.test.ts     -- snapshot tests for surface output
.claude/plugins/cortex/engine/src/domain/extraction.ts       -- transcript parsing, extraction prompt building (pure)
.claude/plugins/cortex/engine/src/domain/extraction.test.ts  -- tests for prompt construction, response parsing
```

### Engine Infrastructure (I/O Shell)

```
.claude/plugins/cortex/engine/src/infra/db.ts                -- SQLite schema, migrations, WAL init, CRUD
.claude/plugins/cortex/engine/src/infra/db.test.ts           -- integration tests (in-memory SQLite)
.claude/plugins/cortex/engine/src/infra/voyage.ts            -- Voyage AI embedding API client
.claude/plugins/cortex/engine/src/infra/voyage.test.ts       -- integration test (mocked HTTP)
.claude/plugins/cortex/engine/src/infra/haiku.ts             -- Haiku API client (extraction, edge classification, consolidation)
.claude/plugins/cortex/engine/src/infra/haiku.test.ts        -- integration test (mocked HTTP)
.claude/plugins/cortex/engine/src/infra/local-embeddings.ts  -- @huggingface/transformers fallback
.claude/plugins/cortex/engine/src/infra/local-embeddings.test.ts -- integration test
.claude/plugins/cortex/engine/src/infra/git-context.ts       -- git branch, commits, diff extraction
.claude/plugins/cortex/engine/src/infra/git-context.test.ts  -- integration test (subprocess)
.claude/plugins/cortex/engine/src/infra/filesystem.ts        -- file read/write, .gitignore management
```

### Engine CLI (Imperative Shell / Orchestration)

```
.claude/plugins/cortex/engine/src/cli.ts                     -- main CLI entrypoint, subcommand dispatch
.claude/plugins/cortex/engine/src/commands/extract.ts         -- extract memories from transcript
.claude/plugins/cortex/engine/src/commands/recall.ts          -- semantic search + FTS5 fallback
.claude/plugins/cortex/engine/src/commands/remember.ts        -- explicit memory creation
.claude/plugins/cortex/engine/src/commands/index-code.ts      -- prose-code pair storage
.claude/plugins/cortex/engine/src/commands/forget.ts          -- archive memory
.claude/plugins/cortex/engine/src/commands/consolidate.ts     -- merge similar memories
.claude/plugins/cortex/engine/src/commands/generate.ts        -- push surface generation
.claude/plugins/cortex/engine/src/commands/lifecycle.ts       -- decay + prune + status transitions
.claude/plugins/cortex/engine/src/config.ts                   -- API keys, paths, thresholds
```

### Engine Build

```
.claude/plugins/cortex/engine/package.json                   -- deps: better-sqlite3, @huggingface/transformers, ts-pattern
.claude/plugins/cortex/engine/tsconfig.json                  -- bun-compatible TS config
.claude/plugins/cortex/engine/build.ts                       -- esbuild bundling script
```

### Plugin Integration (Hooks + Skills)

```
.claude/plugins/cortex/hooks/Stop/extract-and-generate.sh    -- bash wrapper: bun cli.js extract && bun cli.js generate && bun cli.js lifecycle
.claude/plugins/cortex/skills/recall.md                      -- /recall <query> skill definition
.claude/plugins/cortex/skills/remember.md                    -- /remember <text> skill definition
.claude/plugins/cortex/skills/index-code.md                  -- /index-code <path> skill definition
.claude/plugins/cortex/skills/forget.md                      -- /forget <id|query> skill definition
.claude/plugins/cortex/skills/consolidate.md                 -- /consolidate skill definition
```

### Plugin Manifest

```
.claude/plugins/cortex/plugin.json                           -- Claude Code plugin manifest
```

### Project Setup

```
.memory/.gitignore                                           -- ignore cortex.db, cortex.log
```

---

## Component Design

### Memory Domain Types

**Responsibility:** Define all domain types as immutable TypeScript types with discriminated unions.
**Files:** `engine/src/domain/types.ts`
**Interface:**

```typescript
// Memory types with discriminated union for exhaustive matching
type MemoryType = 'architecture' | 'decision' | 'pattern' | 'gotcha' | 'progress' | 'context' | 'code_description' | 'code';
type MemoryCategory = 'project' | 'global';
type MemoryStatus = 'active' | 'superseded' | 'archived' | 'pruned';
type SourceType = 'conversation' | 'explicit' | 'code_index';
type EdgeType = 'relates_to' | 'derived_from' | 'contradicts' | 'exemplifies' | 'refines' | 'supersedes' | 'source_of';

interface Memory {
  readonly id: string;
  readonly content: string;
  readonly summary: string;
  readonly memoryType: MemoryType;
  readonly category: MemoryCategory;
  readonly voyageEmbedding: Float64Array | null;
  readonly localEmbedding: Float64Array | null;
  readonly confidence: number;
  readonly priority: number;
  readonly pinned: boolean;
  readonly sourceType: SourceType;
  readonly sourceSession: string | null;
  readonly sourceContext: string | null;
  readonly tags: readonly string[];
  readonly accessCount: number;
  readonly lastAccessedAt: string | null;
  readonly createdAt: string;
  readonly updatedAt: string;
  readonly status: MemoryStatus;
}

interface Edge {
  readonly id: string;
  readonly sourceId: string;
  readonly targetId: string;
  readonly relationType: EdgeType;
  readonly strength: number;
  readonly bidirectional: boolean;
  readonly createdAt: string;
}

interface ExtractionState {
  readonly id: string;
  readonly sessionId: string;
  readonly cursorPosition: number;
  readonly extractedAt: string;
}

// Extraction output from Haiku
interface ExtractedMemory {
  readonly content: string;
  readonly summary: string;
  readonly memoryType: MemoryType;
  readonly suggestedCategory: MemoryCategory;
  readonly categoryConfidence: number;
  readonly tags: readonly string[];
  readonly priority: number;
}
```

**Depends on:** none

### Ranking Engine (Pure)

**Responsibility:** Score and rank memories for push surface and recall. Pure functions, no I/O.
**Files:** `engine/src/domain/ranking.ts`, `engine/src/domain/ranking.test.ts`
**Interface:**

```typescript
interface RankingInput {
  readonly confidence: number;
  readonly priority: number;
  readonly centrality: number;
  readonly accessCount: number;
  readonly maxLogAccess: number;
}

// FR-022: (confidence * 0.5) + (priority/10 * 0.2) + (centrality * 0.15) + (log(access+1)/max_log * 0.15)
function computeRankScore(input: RankingInput): number;

// Sort + filter for push surface (FR-021: 300-500 tokens target)
function selectPushSurfaceMemories(memories: readonly ScoredMemory[], options: PushSurfaceOptions): readonly ScoredMemory[];

// Merge project + global results for recall (FR-033)
function mergeRecallResults(project: readonly ScoredMemory[], global: readonly ScoredMemory[], limit: number): readonly ScoredMemory[];
```

**Depends on:** types

### Decay Engine (Pure)

**Responsibility:** Calculate confidence decay based on memory type and modifiers. Pure math.
**Files:** `engine/src/domain/decay.ts`, `engine/src/domain/decay.test.ts`
**Interface:**

```typescript
// FR-080-084: half-life lookup + modifiers (pinned, access_count, centrality)
function computeDecay(memory: Memory, centrality: number, now: Date): number;

// FR-085: active -> archived transition check
function shouldArchive(memory: Memory, daysBelowThreshold: number): boolean;

// FR-086: archived -> pruned transition check
function shouldPrune(memory: Memory, daysSinceUpdate: number): boolean;

// Half-life map per MemoryType (architecture=stable, progress=7d, etc.)
const HALF_LIVES: Record<MemoryType, number | null>;
```

**Depends on:** types

### Graph Engine (Pure)

**Responsibility:** Compute in-degree centrality, determine edge creation from similarity scores, validate edge types.
**Files:** `engine/src/domain/graph.ts`, `engine/src/domain/graph.test.ts`
**Interface:**

```typescript
// FR-065: in-degree centrality (count of incoming edges / max_in_degree)
function computeCentrality(memoryId: string, edges: readonly Edge[]): number;

// FR-060-062: classify similarity into action
type SimilarityAction = { type: 'no_relation' } | { type: 'create_edge' } | { type: 'flag_consolidation' };
function classifySimilarity(score: number): SimilarityAction;

// FR-064: filter out 'supersedes' from LLM output
function sanitizeEdgeType(proposed: string): EdgeType;
```

**Depends on:** types

### Similarity (Pure)

**Responsibility:** Cosine similarity between embedding vectors. Pure math.
**Files:** `engine/src/domain/similarity.ts`, `engine/src/domain/similarity.test.ts`
**Interface:**

```typescript
function cosineSimilarity(a: Float64Array, b: Float64Array): number;

// Batch: compare one embedding against many, return sorted by score
function findSimilar(query: Float64Array, candidates: readonly { id: string; embedding: Float64Array }[], threshold: number): readonly { id: string; score: number }[];
```

**Depends on:** none

### Surface Generator (Pure)

**Responsibility:** Generate `.claude/cortex-memory.local.md` markdown content. Pure string transformation.
**Files:** `engine/src/domain/surface.ts`, `engine/src/domain/surface.test.ts`
**Interface:**

```typescript
interface SurfaceInput {
  readonly critical: readonly ScoredMemory[];
  readonly contextSpecific: readonly ScoredMemory[];
  readonly codeIndex: readonly ScoredMemory[];
  readonly existingContent: string | null; // preserve content outside markers
}

// FR-020-025: generate markdown between markers, preserve external content
function generateSurface(input: SurfaceInput): string;
```

**Depends on:** types, ranking

### Extraction Parser (Pure)

**Responsibility:** Build extraction prompts, parse Haiku extraction responses, parse transcripts.
**Files:** `engine/src/domain/extraction.ts`, `engine/src/domain/extraction.test.ts`
**Interface:**

```typescript
// Build extraction prompt from transcript + git context
function buildExtractionPrompt(transcript: string, gitContext: GitContext): string;

// Parse Haiku structured output into ExtractedMemory[]
function parseExtractionResponse(response: string): readonly ExtractedMemory[];

// FR-007: truncate transcript to max chars, respecting message boundaries
function truncateTranscript(transcript: string, maxChars: number): string;

// Parse JSONL transcript (reuse from ts-utils pattern)
function parseTranscript(content: string): string;
```

**Depends on:** types

### SQLite Database (I/O)

**Responsibility:** Schema creation, migrations, WAL mode, CRUD for memories/edges/extractions, FTS5 setup.
**Files:** `engine/src/infra/db.ts`, `engine/src/infra/db.test.ts`
**Interface:**

```typescript
class CortexDB {
  constructor(dbPath: string);
  // Schema + WAL
  initialize(): void;

  // Memories CRUD
  insertMemory(memory: Memory): void;
  getMemory(id: string): Memory | null;
  getActiveMemories(): readonly Memory[];
  getMemoriesByType(type: MemoryType): readonly Memory[];
  updateMemoryStatus(id: string, status: MemoryStatus): void;
  updateMemoryConfidence(id: string, confidence: number): void;
  updateAccessStats(id: string): void;

  // Embeddings
  getMemoriesWithEmbeddings(): readonly { id: string; voyageEmbedding: Float64Array | null; localEmbedding: Float64Array | null }[];
  setVoyageEmbedding(id: string, embedding: Float64Array): void;
  setLocalEmbedding(id: string, embedding: Float64Array): void;

  // FTS5 (FR-032)
  searchFTS(query: string, limit: number): readonly Memory[];

  // Edges CRUD
  insertEdge(edge: Edge): void;
  getEdgesForMemory(memoryId: string): readonly Edge[];
  getAllEdges(): readonly Edge[];

  // Extractions
  getLastExtraction(sessionId: string): ExtractionState | null;
  insertExtraction(extraction: ExtractionState): void;

  // Lifecycle
  getMemoriesBelowConfidence(threshold: number, minDays: number): readonly Memory[];
  getArchivedMemories(olderThanDays: number): readonly Memory[];
  deleteMemory(id: string): void; // actual delete for prune

  // Consolidation
  checkpoint(): string; // returns checkpoint path
  restoreFromCheckpoint(path: string): void;
  getActiveMemoryCount(): number;
  getExtractionCount(): number;

  close(): void;
}
```

**Depends on:** types

### Voyage AI Client (I/O)

**Responsibility:** HTTP client for Voyage AI embedding API. Handles rate limiting, retries.
**Files:** `engine/src/infra/voyage.ts`, `engine/src/infra/voyage.test.ts`
**Interface:**

```typescript
interface VoyageClient {
  embed(texts: readonly string[]): Promise<readonly Float64Array[]>;
  isAvailable(): Promise<boolean>;
}

function createVoyageClient(apiKey: string): VoyageClient;
```

**Depends on:** config

### Haiku API Client (I/O)

**Responsibility:** HTTP client for Anthropic Haiku API. Extraction, edge classification, consolidation.
**Files:** `engine/src/infra/haiku.ts`, `engine/src/infra/haiku.test.ts`
**Interface:**

```typescript
interface HaikuClient {
  extractMemories(prompt: string): Promise<string>; // raw response for pure parser
  classifyEdges(pairs: readonly { sourceContent: string; targetContent: string }[]): Promise<readonly { edgeType: EdgeType; strength: number }[]>;
  consolidateMemories(group: readonly string[]): Promise<string>; // merged content
  isAvailable(): Promise<boolean>;
}

function createHaikuClient(apiKey: string): HaikuClient;
```

**Depends on:** config

### Local Embeddings (I/O)

**Responsibility:** Fallback embedding generation via @huggingface/transformers.
**Files:** `engine/src/infra/local-embeddings.ts`, `engine/src/infra/local-embeddings.test.ts`
**Interface:**

```typescript
interface LocalEmbeddingClient {
  embed(texts: readonly string[]): Promise<readonly Float64Array[]>;
  initialize(): Promise<void>; // model loading (slow first call)
}

function createLocalEmbeddingClient(): LocalEmbeddingClient;
```

**Depends on:** none

### Git Context (I/O)

**Responsibility:** Gather git state: branch, recent commits, changed files.
**Files:** `engine/src/infra/git-context.ts`, `engine/src/infra/git-context.test.ts`
**Interface:**

```typescript
interface GitContext {
  readonly branch: string;
  readonly recentCommits: readonly string[];
  readonly changedFiles: readonly string[];
}

function gatherGitContext(cwd: string): Promise<GitContext>;
```

**Depends on:** none

### CLI Entrypoint

**Responsibility:** Parse args, dispatch to command handlers. Thin orchestration only.
**Files:** `engine/src/cli.ts`
**Interface:**

```
bun cli.js extract --session-id <id> --transcript <path> --cwd <dir>
bun cli.js recall <query> [--project-db <path>] [--global-db <path>]
bun cli.js remember <text> [--type <type>] [--priority <n>] [--global] [--pin]
bun cli.js index-code --prose <text> --code-path <path> --code-content <text>
bun cli.js forget <id-or-query>
bun cli.js consolidate [--auto]
bun cli.js generate [--project-db <path>] [--output <path>]
bun cli.js lifecycle [--project-db <path>]
```

**Depends on:** all commands, config

### Config

**Responsibility:** Load API keys from env vars, resolve DB paths, define thresholds.
**Files:** `engine/src/config.ts`
**Interface:**

```typescript
interface CortexConfig {
  readonly voyageApiKey: string | null;
  readonly anthropicApiKey: string | null;
  readonly projectDbPath: string;
  readonly globalDbPath: string;
  readonly logPath: string;
  readonly maxTranscriptChars: number;
  readonly consolidationTriggerCount: number;
  readonly consolidationTriggerActive: number;
  readonly archiveConfidenceThreshold: number;
  readonly archiveGraceDays: number;
  readonly pruneAfterDays: number;
  readonly autoLinkThreshold: number;
  readonly consolidationThreshold: number;
  readonly manualConsolidationThreshold: number;
}

function loadConfig(cwd: string): CortexConfig;
```

**Depends on:** none

---

## Data Flow

### Session End (Stop Hook)

```
Stop hook (stdin JSON)
  -> extract command
    -> read transcript (I/O) -> truncate (pure) -> gather git context (I/O)
    -> build extraction prompt (pure) -> call Haiku (I/O) -> parse response (pure)
    -> for each extracted memory:
        -> classify category (pure from LLM output)
        -> store memory (I/O: insert to project or global DB)
        -> queue embedding generation (I/O: Voyage API, async)
        -> compute similarity vs existing (pure) -> create edges (I/O)
        -> classify edge types (I/O: batch Haiku call) -> store edges (I/O)
  -> generate command
    -> load active memories (I/O) -> compute centrality (pure) -> compute decay (pure)
    -> rank memories (pure) -> select push surface (pure) -> generate markdown (pure)
    -> write .claude/cortex-memory.local.md (I/O)
  -> lifecycle command
    -> apply decay (pure calc) -> update confidences (I/O)
    -> check archive transitions (pure) -> update statuses (I/O)
    -> check prune transitions (pure) -> delete pruned (I/O)
    -> check consolidation trigger (pure) -> if triggered: consolidate (I/O+pure)
```

### /recall Query

```
Skill invocation -> bun cli.js recall <query>
  -> load config (I/O) -> embed query via Voyage (I/O)
  -> if Voyage unavailable: FTS5 search (I/O)
  -> if Voyage available: cosine similarity (pure) on project DB + global DB
  -> merge results (pure) -> follow source_of edges (I/O) -> format top 10 (pure)
  -> update access stats (I/O) -> output JSON to stdout
```

### /remember Explicit Save

```
Skill invocation -> bun cli.js remember <text> [flags]
  -> parse flags (pure) -> create Memory struct (pure) -> insert to DB (I/O)
  -> queue Voyage embedding (I/O, background) -> output confirmation
```

---

## Implementation Phases

### Phase 1: Foundation -- Types + Pure Domain + DB (no dependencies)

- Define all domain types with discriminated unions (types.ts)
- Implement pure ranking function + push surface selection (ranking.ts)
- Implement pure decay calculation with half-life map (decay.ts)
- Implement cosine similarity + batch search (similarity.ts)
- Implement pure graph centrality + edge classification (graph.ts)
- Implement SQLite schema, WAL init, CRUD, FTS5 (db.ts)
- Implement config loader (config.ts)
- **Files:** `engine/src/domain/types.ts`, `engine/src/domain/ranking.ts`, `engine/src/domain/ranking.test.ts`, `engine/src/domain/decay.ts`, `engine/src/domain/decay.test.ts`, `engine/src/domain/similarity.ts`, `engine/src/domain/similarity.test.ts`, `engine/src/domain/graph.ts`, `engine/src/domain/graph.test.ts`, `engine/src/infra/db.ts`, `engine/src/infra/db.test.ts`, `engine/src/config.ts`, `engine/package.json`, `engine/tsconfig.json`

### Phase 2: I/O Clients + Extraction (depends on Phase 1)

- Implement Voyage AI HTTP client with retry/backoff (voyage.ts)
- Implement Haiku API client for extraction/classification/consolidation (haiku.ts)
- Implement local embedding fallback via @huggingface/transformers (local-embeddings.ts)
- Implement git context gathering (git-context.ts)
- Implement extraction prompt builder + response parser (extraction.ts)
- Implement push surface markdown generator (surface.ts)
- **Files:** `engine/src/infra/voyage.ts`, `engine/src/infra/voyage.test.ts`, `engine/src/infra/haiku.ts`, `engine/src/infra/haiku.test.ts`, `engine/src/infra/local-embeddings.ts`, `engine/src/infra/local-embeddings.test.ts`, `engine/src/infra/git-context.ts`, `engine/src/infra/git-context.test.ts`, `engine/src/domain/extraction.ts`, `engine/src/domain/extraction.test.ts`, `engine/src/domain/surface.ts`, `engine/src/domain/surface.test.ts`

### Phase 3: CLI Commands + Stop Hook (depends on Phase 1+2)

- Implement CLI entrypoint with subcommand dispatch (cli.ts)
- Implement `extract` command: orchestrate transcript parse -> Haiku -> store -> embed -> auto-link
- Implement `recall` command: embed query -> similarity search -> FTS5 fallback -> merge -> output
- Implement `remember` command: parse flags -> store -> queue embedding
- Implement `generate` command: load -> rank -> surface -> write
- Implement `lifecycle` command: decay -> archive -> prune -> consolidation trigger
- Implement Stop hook bash wrapper
- Implement filesystem utilities (gitignore management)
- Implement esbuild bundling script
- **Files:** `engine/src/cli.ts`, `engine/src/commands/extract.ts`, `engine/src/commands/recall.ts`, `engine/src/commands/remember.ts`, `engine/src/commands/generate.ts`, `engine/src/commands/lifecycle.ts`, `engine/src/infra/filesystem.ts`, `engine/build.ts`, `hooks/Stop/extract-and-generate.sh`

### Phase 4: Remaining Commands + Skills + Plugin Manifest (depends on Phase 3)

- Implement `index-code` command: store prose + code pair, create source_of edge
- Implement `forget` command: archive by ID or fuzzy FTS match
- Implement `consolidate` command: checkpoint -> group -> Haiku merge -> archive old
- Write all 5 skill markdown files (recall, remember, index-code, forget, consolidate)
- Write plugin.json manifest
- Create `.memory/.gitignore`
- **Files:** `engine/src/commands/index-code.ts`, `engine/src/commands/forget.ts`, `engine/src/commands/consolidate.ts`, `skills/recall.md`, `skills/remember.md`, `skills/index-code.md`, `skills/forget.md`, `skills/consolidate.md`, `plugin.json`, `.memory/.gitignore`

---

## Testing Strategy

| Component | Unit Tests | Integration Tests | Property Tests |
|-----------|-----------|-------------------|----------------|
| ranking.ts | score formula, surface selection, merge | -- | rank(a) >= rank(b) iff a dominates; pinned always included; score in [0,1] |
| decay.ts | each memory type half-life, modifiers | -- | confidence monotonically decreasing over time; pinned never decays; double half-life with high access |
| similarity.ts | known vector pairs, zero/unit vectors | -- | symmetry: sim(a,b) == sim(b,a); identity: sim(a,a) == 1; range: sim in [-1,1] |
| graph.ts | centrality with known edge sets, edge classification thresholds | -- | centrality in [0,1]; supersedes never from sanitize |
| surface.ts | markdown format, marker preservation, tier ordering | -- | -- |
| extraction.ts | prompt construction, response parsing, transcript truncation | -- | truncate never exceeds max; truncate preserves complete messages |
| db.ts | -- | CRUD with in-memory SQLite, FTS5, WAL mode | -- |
| voyage.ts | -- | mocked HTTP responses | -- |
| haiku.ts | -- | mocked HTTP responses | -- |
| local-embeddings.ts | -- | model load + embed (slow, optional CI gate) | -- |
| git-context.ts | -- | subprocess in temp git repo | -- |
| commands/*.ts | -- | end-to-end with in-memory DB | -- |

---

## Security & NFR Notes

- **Security:** Never send raw code to embedding API (FR-043, NFR-031). Only prose descriptions embedded. Code stored as BLOB in DB. API keys from env vars only (NFR-032). `.memory/` directory auto-gitignored (NFR-033).
- **Performance:** Extraction timeout 30s (NFR-001). Embedding generation async / non-blocking (NFR-004). FTS5 index for sub-second keyword fallback. SQLite WAL for concurrent safety (NFR-012).
- **Cost:** Voyage 200M tokens/month free tier (NFR-021). Haiku extraction ~5k tokens/session, $0.001/session (NFR-022). Total <$0.15/day for 10 sessions.
- **Offline:** Queue failed Voyage embeddings for next session start (NFR-010). Skip Haiku extraction if unavailable, queue for next session (NFR-011). FTS5 always available for recall (NFR-043).
- **Reliability:** Pre-consolidation DB checkpoint (FR-071, NFR-013). Graceful degradation: errors logged to `.memory/cortex.log`, never block session (NFR-014).

---

## Verification

1. `cd .claude/plugins/cortex/engine && bun install && bun run build` -- compiles without errors
2. `cd .claude/plugins/cortex/engine && bun test` -- all unit + property tests pass
3. Manual: start Claude Code session, end session, verify `.claude/cortex-memory.local.md` generated
4. Manual: `/recall "test query"` returns results (or FTS5 fallback if no embeddings)
5. Manual: `/remember "test memory" --type decision --priority 8` creates memory in DB
6. Manual: `/index-code src/example.ts` creates prose-code pair with source_of edge

---

## Unresolved Questions

- `@huggingface/transformers` bun compat? may need WASM backend, verify before Phase 2
- Stop hook stdin format -- spec says `{ session_id, transcript_path, cwd }` but need to verify actual Claude Code Stop hook payload shape
- better-sqlite3 bun native addon -- does `bun install` build correctly on darwin arm64?
- plugin.json schema -- Claude Code plugin manifest format; need to check docs for exact fields
- Voyage API batch limits -- max texts per request? affects embedding queue strategy
