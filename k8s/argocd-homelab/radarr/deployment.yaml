apiVersion: apps/v1
kind: Deployment
metadata:
  name: radarr
  labels:
    app: radarr
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: radarr
  template:
    metadata:
      labels:
        app: radarr
    spec:
      initContainers:
        - name: migrate-paths
          image: alpine:3.21
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache sqlite > /dev/null 2>&1
              DB=/config/radarr.db
              [ ! -f "$DB" ] && exit 0
              sqlite3 "$DB" "UPDATE RootFolders SET Path = REPLACE(Path, '/media/', '/data/media/') WHERE Path LIKE '/media/%';"
              sqlite3 "$DB" "UPDATE Movies SET Path = REPLACE(Path, '/media/', '/data/media/') WHERE Path LIKE '/media/%';"
          volumeMounts:
            - name: config
              mountPath: /config
      containers:
        - name: radarr
          image: linuxserver/radarr:5.18.4
          ports:
            - containerPort: 7878
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: Europe/Copenhagen
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /data
      volumes:
        - name: config
          hostPath:
            path: /var/data/configs/radarr
            type: DirectoryOrCreate
        - name: data
          hostPath:
            path: /var/data
            type: DirectoryOrCreate
