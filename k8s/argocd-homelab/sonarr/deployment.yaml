apiVersion: apps/v1
kind: Deployment
metadata:
  name: sonarr
  labels:
    app: sonarr
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: sonarr
  template:
    metadata:
      labels:
        app: sonarr
    spec:
      initContainers:
        - name: migrate-paths
          image: alpine:3.21
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache sqlite > /dev/null 2>&1
              DB=/config/sonarr.db
              [ ! -f "$DB" ] && exit 0
              sqlite3 "$DB" "UPDATE RootFolders SET Path = REPLACE(Path, '/media/', '/data/media/') WHERE Path LIKE '/media/%';"
              sqlite3 "$DB" "UPDATE Series SET Path = REPLACE(Path, '/media/', '/data/media/') WHERE Path LIKE '/media/%';"
          volumeMounts:
            - name: config
              mountPath: /config
      containers:
        - name: sonarr
          image: linuxserver/sonarr:4.0.13
          ports:
            - containerPort: 8989
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: Europe/Copenhagen
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /data
      volumes:
        - name: config
          hostPath:
            path: /var/data/configs/sonarr
            type: DirectoryOrCreate
        - name: data
          hostPath:
            path: /var/data
            type: DirectoryOrCreate
